'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Textarea } from '@/components/ui/textarea'\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\nimport { Badge } from '@/components/ui/badge'\nimport { \n  Save, \n  X, \n  Loader2, \n  Receipt, \n  User, \n  FileText,\n  CreditCard,\n  Calendar\n} from 'lucide-react'\nimport { InvoiceWithRelations, ClientWithRelations } from '@/types'\nimport { ReceiptFormData } from '@/lib/validations/financial'\nimport { financialUtils } from '@/lib/financial-utils'\nimport { formatCurrency, formatDateTime } from '@/lib/utils'\n\ninterface ReceiptFormProps {\n  invoice?: InvoiceWithRelations | null\n  onSave?: () => void\n  onCancel?: () => void\n}\n\nexport function ReceiptForm({ invoice, onSave, onCancel }: ReceiptFormProps) {\n  const [formData, setFormData] = useState<ReceiptFormData>({\n    invoice_id: '',\n    client_id: '',\n    amount: 0,\n    currency: 'USD',\n    payment_method: 'bank_transfer',\n    payment_reference: '',\n    payment_date: new Date().toISOString(),\n    notes: '',\n    metadata: {}\n  })\n  const [invoices, setInvoices] = useState<InvoiceWithRelations[]>([])\n  const [clients, setClients] = useState<ClientWithRelations[]>([])\n  const [selectedInvoice, setSelectedInvoice] = useState<InvoiceWithRelations | null>(null)\n  const [selectedClient, setSelectedClient] = useState<ClientWithRelations | null>(null)\n  const [remainingAmount, setRemainingAmount] = useState(0)\n  const [isLoading, setIsLoading] = useState(false)\n  const [isLoadingInvoices, setIsLoadingInvoices] = useState(true)\n  const [error, setError] = useState('')\n  const [success, setSuccess] = useState('')\n  \n  const router = useRouter()\n\n  useEffect(() => {\n    if (invoice) {\n      // Pre-populate with invoice data\n      setFormData({\n        invoice_id: invoice.id,\n        client_id: invoice.client_id || '',\n        amount: 0,\n        currency: invoice.currency || 'USD',\n        payment_method: 'bank_transfer',\n        payment_reference: '',\n        payment_date: new Date().toISOString(),\n        notes: '',\n        metadata: {}\n      })\n      setSelectedInvoice(invoice)\n      setSelectedClient(invoice.client || null)\n      calculateRemainingAmount(invoice)\n    } else {\n      fetchInvoices()\n      fetchClients()\n    }\n  }, [invoice])\n\n  const fetchInvoices = async () => {\n    setIsLoadingInvoices(true)\n    try {\n      const response = await fetch('/api/invoices?status=sent&status=overdue&limit=100')\n      const result = await response.json()\n      \n      if (response.ok) {\n        // Only show invoices that can receive payments\n        const payableInvoices = result.data.filter(\n          (inv: InvoiceWithRelations) => ['sent', 'overdue'].includes(inv.status)\n        )\n        setInvoices(payableInvoices)\n      }\n    } catch (error) {\n      console.error('Failed to fetch invoices:', error)\n    } finally {\n      setIsLoadingInvoices(false)\n    }\n  }\n\n  const fetchClients = async () => {\n    try {\n      const response = await fetch('/api/clients?limit=100')\n      const result = await response.json()\n      \n      if (response.ok) {\n        setClients(result.data)\n      }\n    } catch (error) {\n      console.error('Failed to fetch clients:', error)\n    }\n  }\n\n  const calculateRemainingAmount = async (selectedInv: InvoiceWithRelations) => {\n    try {\n      const response = await fetch(`/api/receipts?invoice_id=${selectedInv.id}`)\n      const result = await response.json()\n      \n      if (response.ok) {\n        const totalPaid = result.data.reduce((sum: number, receipt: any) => sum + receipt.amount, 0)\n        const remaining = selectedInv.amount - totalPaid\n        setRemainingAmount(remaining)\n        \n        // Set default amount to remaining amount\n        setFormData(prev => ({ ...prev, amount: remaining }))\n      }\n    } catch (error) {\n      console.error('Failed to calculate remaining amount:', error)\n      setRemainingAmount(selectedInv.amount)\n      setFormData(prev => ({ ...prev, amount: selectedInv.amount }))\n    }\n  }\n\n  const handleInvoiceChange = (invoiceId: string) => {\n    const selectedInv = invoices.find(inv => inv.id === invoiceId)\n    if (selectedInv) {\n      setSelectedInvoice(selectedInv)\n      setSelectedClient(selectedInv.client || null)\n      setFormData(prev => ({\n        ...prev,\n        invoice_id: invoiceId,\n        client_id: selectedInv.client_id || '',\n        currency: selectedInv.currency || 'USD'\n      }))\n      calculateRemainingAmount(selectedInv)\n    }\n  }\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setIsLoading(true)\n    setError('')\n    setSuccess('')\n\n    try {\n      const response = await fetch('/api/receipts', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(formData)\n      })\n\n      const result = await response.json()\n\n      if (!response.ok) {\n        throw new Error(result.error || 'Failed to create receipt')\n      }\n\n      setSuccess('Receipt created successfully!')\n      \n      if (onSave) {\n        setTimeout(() => onSave(), 1000)\n      } else {\n        setTimeout(() => {\n          router.push('/dashboard/receipts')\n        }, 1000)\n      }\n    } catch (error) {\n      setError(error instanceof Error ? error.message : 'An error occurred')\n    } finally {\n      setIsLoading(false)\n    }\n  }\n\n  const updateFormData = (field: string, value: any) => {\n    setFormData(prev => ({ ...prev, [field]: value }))\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Receipt className=\"h-5 w-5\" />\n              Record Payment Receipt\n            </CardTitle>\n            <CardDescription>\n              Record a payment received for an invoice\n            </CardDescription>\n          </div>\n          {onCancel && (\n            <Button variant=\"ghost\" size=\"icon\" onClick={onCancel}>\n              <X className=\"h-4 w-4\" />\n            </Button>\n          )}\n        </div>\n      </CardHeader>\n      <CardContent>\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          {/* Invoice Selection */}\n          {!invoice && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2 mb-4\">\n                <FileText className=\"h-4 w-4\" />\n                <h3 className=\"text-lg font-medium\">Invoice Information</h3>\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label htmlFor=\"invoice_id\">Invoice *</Label>\n                <Select\n                  value={formData.invoice_id}\n                  onValueChange={handleInvoiceChange}\n                  disabled={isLoading || isLoadingInvoices}\n                >\n                  <SelectTrigger>\n                    <SelectValue placeholder=\"Select an invoice\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {invoices.map((inv) => (\n                      <SelectItem key={inv.id} value={inv.id}>\n                        <div className=\"flex items-center gap-2\">\n                          <span className=\"font-medium\">{inv.invoice_number}</span>\n                          <Badge className={financialUtils.getInvoiceStatusColor(inv.status)} size=\"sm\">\n                            {financialUtils.getInvoiceStatusDisplayName(inv.status)}\n                          </Badge>\n                          <span className=\"text-sm text-muted-foreground\">\n                            {formatCurrency(inv.amount, inv.currency)}\n                          </span>\n                        </div>\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n          )}\n\n          {/* Selected Invoice Details */}\n          {selectedInvoice && (\n            <div className=\"p-4 bg-muted rounded-lg\">\n              <h4 className=\"font-medium mb-3\">Invoice Details</h4>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div>\n                  <span className=\"text-sm text-muted-foreground\">Invoice Number:</span>\n                  <div className=\"font-medium\">{selectedInvoice.invoice_number}</div>\n                </div>\n                <div>\n                  <span className=\"text-sm text-muted-foreground\">Client:</span>\n                  <div className=\"font-medium\">{selectedClient?.name}</div>\n                </div>\n                <div>\n                  <span className=\"text-sm text-muted-foreground\">Invoice Amount:</span>\n                  <div className=\"font-medium\">{formatCurrency(selectedInvoice.amount, selectedInvoice.currency)}</div>\n                </div>\n                <div>\n                  <span className=\"text-sm text-muted-foreground\">Remaining Amount:</span>\n                  <div className=\"font-medium text-orange-600\">\n                    {formatCurrency(remainingAmount, selectedInvoice.currency)}\n                  </div>\n                </div>\n                <div>\n                  <span className=\"text-sm text-muted-foreground\">Status:</span>\n                  <Badge className={financialUtils.getInvoiceStatusColor(selectedInvoice.status)} size=\"sm\">\n                    {financialUtils.getInvoiceStatusDisplayName(selectedInvoice.status)}\n                  </Badge>\n                </div>\n                <div>\n                  <span className=\"text-sm text-muted-foreground\">Due Date:</span>\n                  <div className=\"font-medium\">\n                    {selectedInvoice.due_date ? formatDateTime(selectedInvoice.due_date) : 'Not set'}\n                  </div>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Payment Details */}\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center gap-2 mb-4\">\n              <CreditCard className=\"h-4 w-4\" />\n              <h3 className=\"text-lg font-medium\">Payment Details</h3>\n            </div>\n            \n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"amount\">Payment Amount *</Label>\n                <Input\n                  id=\"amount\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  min=\"0.01\"\n                  max={remainingAmount}\n                  value={formData.amount}\n                  onChange={(e) => updateFormData('amount', parseFloat(e.target.value) || 0)}\n                  disabled={isLoading}\n                  required\n                />\n                {remainingAmount > 0 && (\n                  <p className=\"text-xs text-muted-foreground\">\n                    Maximum: {formatCurrency(remainingAmount, formData.currency)}\n                  </p>\n                )}\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"payment_method\">Payment Method *</Label>\n                <Select\n                  value={formData.payment_method}\n                  onValueChange={(value) => updateFormData('payment_method', value)}\n                  disabled={isLoading}\n                >\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {financialUtils.getAllPaymentMethods().map((method) => (\n                      <SelectItem key={method.value} value={method.value}>\n                        {method.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"payment_reference\">Payment Reference</Label>\n                <Input\n                  id=\"payment_reference\"\n                  value={formData.payment_reference}\n                  onChange={(e) => updateFormData('payment_reference', e.target.value)}\n                  placeholder=\"Transaction ID, check number, etc.\"\n                  disabled={isLoading}\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"payment_date\">Payment Date *</Label>\n                <Input\n                  id=\"payment_date\"\n                  type=\"datetime-local\"\n                  value={formData.payment_date ? new Date(formData.payment_date).toISOString().slice(0, 16) : ''}\n                  onChange={(e) => updateFormData('payment_date', e.target.value ? new Date(e.target.value).toISOString() : new Date().toISOString())}\n                  disabled={isLoading}\n                  required\n                />\n              </div>\n            </div>\n          </div>\n\n          {/* Notes */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"notes\">Notes</Label>\n            <Textarea\n              id=\"notes\"\n              value={formData.notes}\n              onChange={(e) => updateFormData('notes', e.target.value)}\n              placeholder=\"Additional notes about this payment\"\n              rows={3}\n              disabled={isLoading}\n            />\n          </div>\n\n          {/* Payment Summary */}\n          {selectedInvoice && formData.amount > 0 && (\n            <div className=\"p-4 bg-blue-50 rounded-lg\">\n              <h4 className=\"font-medium mb-2\">Payment Summary</h4>\n              <div className=\"space-y-2 text-sm\">\n                <div className=\"flex justify-between\">\n                  <span>Payment Amount:</span>\n                  <span className=\"font-medium\">{formatCurrency(formData.amount, formData.currency)}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span>Remaining After Payment:</span>\n                  <span className=\"font-medium\">\n                    {formatCurrency(remainingAmount - formData.amount, formData.currency)}\n                  </span>\n                </div>\n                {remainingAmount - formData.amount <= 0 && (\n                  <div className=\"text-green-600 font-medium\">\n                    ✓ This payment will mark the invoice as fully paid\n                  </div>\n                )}\n              </div>\n            </div>\n          )}\n\n          {success && (\n            <div className=\"text-sm text-green-600 bg-green-50 p-3 rounded-md\">\n              {success}\n            </div>\n          )}\n\n          {error && (\n            <div className=\"text-sm text-red-600 bg-red-50 p-3 rounded-md\">\n              {error}\n            </div>\n          )}\n\n          <div className=\"flex justify-end gap-2\">\n            {onCancel && (\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={onCancel}\n                disabled={isLoading}\n              >\n                Cancel\n              </Button>\n            )}\n            <Button\n              type=\"submit\"\n              disabled={isLoading || !formData.invoice_id || formData.amount <= 0 || formData.amount > remainingAmount}\n              className=\"bg-g1-primary hover:bg-g1-primary/90\"\n            >\n              {isLoading ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Recording Payment...\n                </>\n              ) : (\n                <>\n                  <Save className=\"mr-2 h-4 w-4\" />\n                  Record Payment\n                </>\n              )}\n            </Button>\n          </div>\n        </form>\n      </CardContent>\n    </Card>\n  )\n}"