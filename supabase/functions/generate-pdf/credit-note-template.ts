import { SupabaseClient } from 'jsr:@supabase/supabase-js@2'\nimport { generatePDFFromHTML, formatCurrency, formatDate, formatDateTime, getCompanyLogo, COMPANY_INFO, PDFOptions, PDFResult } from '../_shared/pdf-utils.ts'\n\nexport async function generateCreditNotePDF(\n  supabase: SupabaseClient,\n  creditNoteId: string,\n  options: PDFOptions = {}\n): Promise<PDFResult> {\n  // Fetch credit note data with related information\n  const { data: creditNote, error } = await supabase\n    .from('credit_notes')\n    .select(`\n      *,\n      client:clients(*),\n      invoice:invoices(\n        id,\n        invoice_number,\n        amount,\n        skr:skrs(id, skr_number)\n      )\n    `)\n    .eq('id', creditNoteId)\n    .single()\n\n  if (error || !creditNote) {\n    throw new Error(`Credit note not found: ${error?.message || 'Unknown error'}`)\n  }\n\n  // Get reason display name\n  const getReasonName = (reason: string) => {\n    const reasons: Record<string, string> = {\n      return: 'Return',\n      discount: 'Discount',\n      error: 'Error Correction',\n      cancellation: 'Cancellation',\n      other: 'Other'\n    }\n    return reasons[reason] || reason\n  }\n\n  // Get status display name\n  const getStatusName = (status: string) => {\n    const statuses: Record<string, string> = {\n      draft: 'Draft',\n      issued: 'Issued',\n      applied: 'Applied'\n    }\n    return statuses[status] || status\n  }\n\n  // Create HTML template\n  const html = `\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <meta charset=\"utf-8\">\n      <title>Credit Note - ${creditNote.credit_note_number}</title>\n      <style>\n        body {\n          font-family: 'Arial', sans-serif;\n          margin: 0;\n          padding: 20px;\n          color: #333;\n          line-height: 1.6;\n        }\n        .header {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          border-bottom: 3px solid #c53030;\n          padding-bottom: 20px;\n          margin-bottom: 30px;\n        }\n        .logo {\n          width: 120px;\n          height: auto;\n        }\n        .company-info {\n          text-align: right;\n          font-size: 12px;\n          color: #666;\n        }\n        .document-title {\n          font-size: 32px;\n          font-weight: bold;\n          color: #c53030;\n          margin: 20px 0;\n          text-align: center;\n        }\n        .credit-note-number {\n          text-align: center;\n          font-size: 18px;\n          font-weight: bold;\n          color: #c53030;\n          margin-bottom: 30px;\n          padding: 10px;\n          border: 2px solid #c53030;\n          display: inline-block;\n          width: 100%;\n          box-sizing: border-box;\n        }\n        .section {\n          margin-bottom: 25px;\n          padding: 15px;\n          border: 1px solid #e2e8f0;\n          border-radius: 5px;\n        }\n        .section-title {\n          font-size: 16px;\n          font-weight: bold;\n          color: #c53030;\n          margin-bottom: 15px;\n          border-bottom: 1px solid #cbd5e0;\n          padding-bottom: 5px;\n        }\n        .info-grid {\n          display: grid;\n          grid-template-columns: 1fr 1fr;\n          gap: 15px;\n        }\n        .info-item {\n          display: flex;\n          flex-direction: column;\n        }\n        .info-label {\n          font-weight: bold;\n          color: #4a5568;\n          font-size: 12px;\n          text-transform: uppercase;\n          margin-bottom: 3px;\n        }\n        .info-value {\n          font-size: 14px;\n          color: #2d3748;\n        }\n        .amount-section {\n          background-color: #fed7d7;\n          border: 2px solid #c53030;\n          border-radius: 10px;\n          padding: 20px;\n          text-align: center;\n          margin: 30px 0;\n        }\n        .amount-label {\n          font-size: 16px;\n          color: #4a5568;\n          margin-bottom: 10px;\n        }\n        .amount-value {\n          font-size: 36px;\n          font-weight: bold;\n          color: #c53030;\n        }\n        .reason-badge {\n          display: inline-block;\n          padding: 6px 16px;\n          background-color: #fbb6ce;\n          color: #97266d;\n          border-radius: 20px;\n          font-size: 14px;\n          font-weight: bold;\n        }\n        .status-badge {\n          display: inline-block;\n          padding: 4px 12px;\n          border-radius: 20px;\n          font-size: 12px;\n          font-weight: bold;\n          text-transform: uppercase;\n        }\n        .status-draft {\n          background-color: #e2e8f0;\n          color: #4a5568;\n        }\n        .status-issued {\n          background-color: #bee3f8;\n          color: #2a69ac;\n        }\n        .status-applied {\n          background-color: #c6f6d5;\n          color: #22543d;\n        }\n        .items-table {\n          width: 100%;\n          border-collapse: collapse;\n          margin: 20px 0;\n        }\n        .items-table th {\n          background-color: #c53030;\n          color: white;\n          padding: 12px;\n          text-align: left;\n          font-weight: bold;\n        }\n        .items-table td {\n          padding: 12px;\n          border-bottom: 1px solid #e2e8f0;\n        }\n        .items-table tr:nth-child(even) {\n          background-color: #f7fafc;\n        }\n        .text-right {\n          text-align: right;\n        }\n        .text-center {\n          text-align: center;\n        }\n        .footer {\n          margin-top: 40px;\n          padding-top: 20px;\n          border-top: 1px solid #e2e8f0;\n          font-size: 11px;\n          color: #718096;\n          text-align: center;\n        }\n        .watermark {\n          position: fixed;\n          top: 50%;\n          left: 50%;\n          transform: translate(-50%, -50%) rotate(-45deg);\n          font-size: 72px;\n          color: rgba(0, 0, 0, 0.1);\n          z-index: -1;\n          font-weight: bold;\n        }\n        .warning-box {\n          background-color: #fffbeb;\n          border: 1px solid #f59e0b;\n          border-radius: 5px;\n          padding: 15px;\n          margin: 20px 0;\n        }\n        .warning-title {\n          font-weight: bold;\n          color: #92400e;\n          margin-bottom: 5px;\n        }\n      </style>\n    </head>\n    <body>\n      ${options.watermark ? `<div class=\"watermark\">${options.watermark}</div>` : ''}\n      \n      <!-- Header -->\n      <div class=\"header\">\n        <div>\n          <img src=\"${getCompanyLogo()}\" alt=\"G1 Holding\" class=\"logo\">\n        </div>\n        <div class=\"company-info\">\n          <div><strong>${COMPANY_INFO.name}</strong></div>\n          <div>${COMPANY_INFO.address.street}</div>\n          <div>${COMPANY_INFO.address.city}, ${COMPANY_INFO.address.country}</div>\n          <div>${COMPANY_INFO.address.postal}</div>\n          <div>Tel: ${COMPANY_INFO.contact.phone}</div>\n          <div>Email: ${COMPANY_INFO.contact.email}</div>\n        </div>\n      </div>\n\n      <!-- Document Title -->\n      <div class=\"document-title\">CREDIT NOTE</div>\n      \n      <!-- Credit Note Number -->\n      <div class=\"credit-note-number\">${creditNote.credit_note_number}</div>\n\n      <!-- Amount Section -->\n      <div class=\"amount-section\">\n        <div class=\"amount-label\">Credit Amount</div>\n        <div class=\"amount-value\">-${formatCurrency(creditNote.amount, creditNote.currency)}</div>\n      </div>\n\n      <!-- Credit Note Information -->\n      <div class=\"section\">\n        <div class=\"section-title\">Credit Note Information</div>\n        <div class=\"info-grid\">\n          <div class=\"info-item\">\n            <div class=\"info-label\">Issue Date</div>\n            <div class=\"info-value\">${formatDate(creditNote.created_at)}</div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Status</div>\n            <div class=\"info-value\">\n              <span class=\"status-badge status-${creditNote.status}\">${getStatusName(creditNote.status)}</span>\n            </div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Reason</div>\n            <div class=\"info-value\">\n              <span class=\"reason-badge\">${getReasonName(creditNote.reason)}</span>\n            </div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Currency</div>\n            <div class=\"info-value\">${creditNote.currency}</div>\n          </div>\n        </div>\n      </div>\n\n      <!-- Description -->\n      <div class=\"section\">\n        <div class=\"section-title\">Description</div>\n        <div class=\"info-value\">${creditNote.description}</div>\n      </div>\n\n      <!-- Client Information -->\n      <div class=\"section\">\n        <div class=\"section-title\">Client Information</div>\n        <div class=\"info-grid\">\n          <div class=\"info-item\">\n            <div class=\"info-label\">Client Name</div>\n            <div class=\"info-value\">${creditNote.client?.name || 'N/A'}</div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Email</div>\n            <div class=\"info-value\">${creditNote.client?.email || 'N/A'}</div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Country</div>\n            <div class=\"info-value\">${creditNote.client?.country || 'N/A'}</div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Client Type</div>\n            <div class=\"info-value\">${creditNote.client?.type?.replace('_', ' ').toUpperCase() || 'N/A'}</div>\n          </div>\n        </div>\n      </div>\n\n      <!-- Related Invoice -->\n      ${creditNote.invoice ? `\n      <div class=\"section\">\n        <div class=\"section-title\">Related Invoice</div>\n        <div class=\"info-grid\">\n          <div class=\"info-item\">\n            <div class=\"info-label\">Invoice Number</div>\n            <div class=\"info-value\">${creditNote.invoice.invoice_number}</div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Original Invoice Amount</div>\n            <div class=\"info-value\">${formatCurrency(creditNote.invoice.amount, creditNote.currency)}</div>\n          </div>\n          ${creditNote.invoice.skr ? `\n          <div class=\"info-item\">\n            <div class=\"info-label\">Related SKR</div>\n            <div class=\"info-value\">${creditNote.invoice.skr.skr_number}</div>\n          </div>\n          ` : ''}\n          <div class=\"info-item\">\n            <div class=\"info-label\">Effective Invoice Amount</div>\n            <div class=\"info-value\">${formatCurrency(creditNote.invoice.amount - creditNote.amount, creditNote.currency)}</div>\n          </div>\n        </div>\n      </div>\n      ` : ''}\n\n      <!-- Items (if any) -->\n      ${creditNote.items && creditNote.items.length > 0 ? `\n      <div class=\"section\">\n        <div class=\"section-title\">Credit Note Items</div>\n        <table class=\"items-table\">\n          <thead>\n            <tr>\n              <th style=\"width: 50%;\">Description</th>\n              <th class=\"text-center\" style=\"width: 15%;\">Quantity</th>\n              <th class=\"text-right\" style=\"width: 15%;\">Unit Price</th>\n              <th class=\"text-right\" style=\"width: 20%;\">Total</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${creditNote.items.map((item: any) => `\n              <tr>\n                <td>${item.description}</td>\n                <td class=\"text-center\">${item.quantity}</td>\n                <td class=\"text-right\">${formatCurrency(item.unit_price, creditNote.currency)}</td>\n                <td class=\"text-right\">-${formatCurrency(item.total, creditNote.currency)}</td>\n              </tr>\n            `).join('')}\n          </tbody>\n        </table>\n      </div>\n      ` : ''}\n\n      <!-- Warning Box -->\n      <div class=\"warning-box\">\n        <div class=\"warning-title\">Important Notice</div>\n        <div>This credit note reduces the amount owed on the related invoice. Please adjust your records accordingly. If you have any questions about this credit note, please contact our finance department.</div>\n      </div>\n\n      <!-- Notes -->\n      ${creditNote.notes ? `\n      <div class=\"section\">\n        <div class=\"section-title\">Additional Notes</div>\n        <div class=\"info-value\">${creditNote.notes}</div>\n      </div>\n      ` : ''}\n\n      <!-- Footer -->\n      <div class=\"footer\">\n        <div style=\"margin-bottom: 10px;\">\n          <strong>This credit note has been issued by G1 Holding</strong>\n        </div>\n        <div>This credit note was generated electronically by G1 Holding's financial system.</div>\n        <div>Registration Number: ${COMPANY_INFO.registration.number} | VAT Number: ${COMPANY_INFO.registration.vat}</div>\n        <div>Generated on: ${formatDateTime(new Date().toISOString())}</div>\n        <div style=\"margin-top: 10px; font-style: italic;\">\n          Please retain this credit note for your records\n        </div>\n      </div>\n    </body>\n    </html>\n  `\n\n  // Generate filename\n  const filename = `CreditNote-${creditNote.credit_note_number}-${new Date().toISOString().split('T')[0]}.pdf`\n\n  // Generate PDF\n  return await generatePDFFromHTML(html, filename)\n}"