import { SupabaseClient } from 'jsr:@supabase/supabase-js@2'\nimport { generatePDFFromHTML, formatCurrency, formatDate, formatDateTime, getCompanyLogo, COMPANY_INFO, PDFOptions, PDFResult } from '../_shared/pdf-utils.ts'\n\nexport async function generateReceiptPDF(\n  supabase: SupabaseClient,\n  receiptId: string,\n  options: PDFOptions = {}\n): Promise<PDFResult> {\n  // Fetch receipt data with related information\n  const { data: receipt, error } = await supabase\n    .from('receipts')\n    .select(`\n      *,\n      client:clients(*),\n      invoice:invoices(\n        id,\n        invoice_number,\n        amount,\n        skr:skrs(id, skr_number)\n      )\n    `)\n    .eq('id', receiptId)\n    .single()\n\n  if (error || !receipt) {\n    throw new Error(`Receipt not found: ${error?.message || 'Unknown error'}`)\n  }\n\n  // Get payment method display name\n  const getPaymentMethodName = (method: string) => {\n    const methods: Record<string, string> = {\n      cash: 'Cash',\n      bank_transfer: 'Bank Transfer',\n      credit_card: 'Credit Card',\n      debit_card: 'Debit Card',\n      check: 'Check',\n      crypto: 'Cryptocurrency',\n      other: 'Other'\n    }\n    return methods[method] || method\n  }\n\n  // Create HTML template\n  const html = `\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <meta charset=\"utf-8\">\n      <title>Receipt - ${receipt.receipt_number}</title>\n      <style>\n        body {\n          font-family: 'Arial', sans-serif;\n          margin: 0;\n          padding: 20px;\n          color: #333;\n          line-height: 1.6;\n        }\n        .header {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          border-bottom: 3px solid #22543d;\n          padding-bottom: 20px;\n          margin-bottom: 30px;\n        }\n        .logo {\n          width: 120px;\n          height: auto;\n        }\n        .company-info {\n          text-align: right;\n          font-size: 12px;\n          color: #666;\n        }\n        .document-title {\n          font-size: 32px;\n          font-weight: bold;\n          color: #22543d;\n          margin: 20px 0;\n          text-align: center;\n        }\n        .receipt-number {\n          text-align: center;\n          font-size: 18px;\n          font-weight: bold;\n          color: #22543d;\n          margin-bottom: 30px;\n          padding: 10px;\n          border: 2px solid #22543d;\n          display: inline-block;\n          width: 100%;\n          box-sizing: border-box;\n        }\n        .section {\n          margin-bottom: 25px;\n          padding: 15px;\n          border: 1px solid #e2e8f0;\n          border-radius: 5px;\n        }\n        .section-title {\n          font-size: 16px;\n          font-weight: bold;\n          color: #22543d;\n          margin-bottom: 15px;\n          border-bottom: 1px solid #cbd5e0;\n          padding-bottom: 5px;\n        }\n        .info-grid {\n          display: grid;\n          grid-template-columns: 1fr 1fr;\n          gap: 15px;\n        }\n        .info-item {\n          display: flex;\n          flex-direction: column;\n        }\n        .info-label {\n          font-weight: bold;\n          color: #4a5568;\n          font-size: 12px;\n          text-transform: uppercase;\n          margin-bottom: 3px;\n        }\n        .info-value {\n          font-size: 14px;\n          color: #2d3748;\n        }\n        .amount-section {\n          background-color: #f0fff4;\n          border: 2px solid #22543d;\n          border-radius: 10px;\n          padding: 20px;\n          text-align: center;\n          margin: 30px 0;\n        }\n        .amount-label {\n          font-size: 16px;\n          color: #4a5568;\n          margin-bottom: 10px;\n        }\n        .amount-value {\n          font-size: 36px;\n          font-weight: bold;\n          color: #22543d;\n        }\n        .payment-method {\n          display: inline-block;\n          padding: 6px 16px;\n          background-color: #bee3f8;\n          color: #2a69ac;\n          border-radius: 20px;\n          font-size: 14px;\n          font-weight: bold;\n        }\n        .footer {\n          margin-top: 40px;\n          padding-top: 20px;\n          border-top: 1px solid #e2e8f0;\n          font-size: 11px;\n          color: #718096;\n          text-align: center;\n        }\n        .watermark {\n          position: fixed;\n          top: 50%;\n          left: 50%;\n          transform: translate(-50%, -50%) rotate(-45deg);\n          font-size: 72px;\n          color: rgba(0, 0, 0, 0.1);\n          z-index: -1;\n          font-weight: bold;\n        }\n        .thank-you {\n          background-color: #f7fafc;\n          padding: 20px;\n          border-radius: 5px;\n          text-align: center;\n          margin: 30px 0;\n          font-size: 18px;\n          color: #22543d;\n          font-weight: bold;\n        }\n      </style>\n    </head>\n    <body>\n      ${options.watermark ? `<div class=\"watermark\">${options.watermark}</div>` : ''}\n      \n      <!-- Header -->\n      <div class=\"header\">\n        <div>\n          <img src=\"${getCompanyLogo()}\" alt=\"G1 Holding\" class=\"logo\">\n        </div>\n        <div class=\"company-info\">\n          <div><strong>${COMPANY_INFO.name}</strong></div>\n          <div>${COMPANY_INFO.address.street}</div>\n          <div>${COMPANY_INFO.address.city}, ${COMPANY_INFO.address.country}</div>\n          <div>${COMPANY_INFO.address.postal}</div>\n          <div>Tel: ${COMPANY_INFO.contact.phone}</div>\n          <div>Email: ${COMPANY_INFO.contact.email}</div>\n        </div>\n      </div>\n\n      <!-- Document Title -->\n      <div class=\"document-title\">PAYMENT RECEIPT</div>\n      \n      <!-- Receipt Number -->\n      <div class=\"receipt-number\">${receipt.receipt_number}</div>\n\n      <!-- Amount Section -->\n      <div class=\"amount-section\">\n        <div class=\"amount-label\">Amount Received</div>\n        <div class=\"amount-value\">${formatCurrency(receipt.amount, receipt.currency)}</div>\n      </div>\n\n      <!-- Payment Information -->\n      <div class=\"section\">\n        <div class=\"section-title\">Payment Information</div>\n        <div class=\"info-grid\">\n          <div class=\"info-item\">\n            <div class=\"info-label\">Payment Date</div>\n            <div class=\"info-value\">${formatDateTime(receipt.payment_date)}</div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Payment Method</div>\n            <div class=\"info-value\">\n              <span class=\"payment-method\">${getPaymentMethodName(receipt.payment_method)}</span>\n            </div>\n          </div>\n          ${receipt.payment_reference ? `\n          <div class=\"info-item\">\n            <div class=\"info-label\">Payment Reference</div>\n            <div class=\"info-value\">${receipt.payment_reference}</div>\n          </div>\n          ` : ''}\n          <div class=\"info-item\">\n            <div class=\"info-label\">Currency</div>\n            <div class=\"info-value\">${receipt.currency}</div>\n          </div>\n        </div>\n      </div>\n\n      <!-- Client Information -->\n      <div class=\"section\">\n        <div class=\"section-title\">Client Information</div>\n        <div class=\"info-grid\">\n          <div class=\"info-item\">\n            <div class=\"info-label\">Client Name</div>\n            <div class=\"info-value\">${receipt.client?.name || 'N/A'}</div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Email</div>\n            <div class=\"info-value\">${receipt.client?.email || 'N/A'}</div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Country</div>\n            <div class=\"info-value\">${receipt.client?.country || 'N/A'}</div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Client Type</div>\n            <div class=\"info-value\">${receipt.client?.type?.replace('_', ' ').toUpperCase() || 'N/A'}</div>\n          </div>\n        </div>\n      </div>\n\n      <!-- Invoice Information -->\n      ${receipt.invoice ? `\n      <div class=\"section\">\n        <div class=\"section-title\">Related Invoice</div>\n        <div class=\"info-grid\">\n          <div class=\"info-item\">\n            <div class=\"info-label\">Invoice Number</div>\n            <div class=\"info-value\">${receipt.invoice.invoice_number}</div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Invoice Amount</div>\n            <div class=\"info-value\">${formatCurrency(receipt.invoice.amount, receipt.currency)}</div>\n          </div>\n          ${receipt.invoice.skr ? `\n          <div class=\"info-item\">\n            <div class=\"info-label\">Related SKR</div>\n            <div class=\"info-value\">${receipt.invoice.skr.skr_number}</div>\n          </div>\n          ` : ''}\n        </div>\n      </div>\n      ` : ''}\n\n      <!-- Notes -->\n      ${receipt.notes ? `\n      <div class=\"section\">\n        <div class=\"section-title\">Notes</div>\n        <div class=\"info-value\">${receipt.notes}</div>\n      </div>\n      ` : ''}\n\n      <!-- Thank You Message -->\n      <div class=\"thank-you\">\n        Thank you for your payment!\n      </div>\n\n      <!-- Footer -->\n      <div class=\"footer\">\n        <div style=\"margin-bottom: 10px;\">\n          <strong>This receipt confirms payment received by G1 Holding</strong>\n        </div>\n        <div>This receipt was generated electronically by G1 Holding's financial system.</div>\n        <div>Registration Number: ${COMPANY_INFO.registration.number} | VAT Number: ${COMPANY_INFO.registration.vat}</div>\n        <div>Generated on: ${formatDateTime(new Date().toISOString())}</div>\n        <div style=\"margin-top: 10px; font-style: italic;\">\n          Please retain this receipt for your records\n        </div>\n      </div>\n    </body>\n    </html>\n  `\n\n  // Generate filename\n  const filename = `Receipt-${receipt.receipt_number}-${new Date().toISOString().split('T')[0]}.pdf`\n\n  // Generate PDF\n  return await generatePDFFromHTML(html, filename)\n}"