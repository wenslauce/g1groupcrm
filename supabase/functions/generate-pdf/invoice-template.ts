import { SupabaseClient } from 'jsr:@supabase/supabase-js@2'\nimport { generatePDFFromHTML, formatCurrency, formatDate, formatDateTime, getCompanyLogo, COMPANY_INFO, PDFOptions, PDFResult } from '../_shared/pdf-utils.ts'\n\nexport async function generateInvoicePDF(\n  supabase: SupabaseClient,\n  invoiceId: string,\n  options: PDFOptions = {}\n): Promise<PDFResult> {\n  // Fetch invoice data with related information\n  const { data: invoice, error } = await supabase\n    .from('invoices')\n    .select(`\n      *,\n      client:clients(*),\n      skr:skrs(\n        id,\n        skr_number,\n        asset:assets(id, asset_name, asset_type)\n      )\n    `)\n    .eq('id', invoiceId)\n    .single()\n\n  if (error || !invoice) {\n    throw new Error(`Invoice not found: ${error?.message || 'Unknown error'}`)\n  }\n\n  // Calculate totals\n  const subtotal = invoice.subtotal || 0\n  const taxAmount = invoice.tax_amount || 0\n  const discountAmount = invoice.discount_amount || 0\n  const total = invoice.amount || 0\n\n  // Create HTML template\n  const html = `\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <meta charset=\"utf-8\">\n      <title>Invoice - ${invoice.invoice_number}</title>\n      <style>\n        body {\n          font-family: 'Arial', sans-serif;\n          margin: 0;\n          padding: 20px;\n          color: #333;\n          line-height: 1.6;\n        }\n        .header {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          border-bottom: 3px solid #1a365d;\n          padding-bottom: 20px;\n          margin-bottom: 30px;\n        }\n        .logo {\n          width: 120px;\n          height: auto;\n        }\n        .company-info {\n          text-align: right;\n          font-size: 12px;\n          color: #666;\n        }\n        .document-title {\n          font-size: 32px;\n          font-weight: bold;\n          color: #1a365d;\n          margin: 20px 0;\n        }\n        .invoice-details {\n          display: grid;\n          grid-template-columns: 1fr 1fr;\n          gap: 40px;\n          margin-bottom: 30px;\n        }\n        .bill-to, .invoice-info {\n          padding: 20px;\n          border: 1px solid #e2e8f0;\n          border-radius: 5px;\n        }\n        .section-title {\n          font-size: 16px;\n          font-weight: bold;\n          color: #1a365d;\n          margin-bottom: 15px;\n          border-bottom: 1px solid #cbd5e0;\n          padding-bottom: 5px;\n        }\n        .info-item {\n          margin-bottom: 8px;\n        }\n        .info-label {\n          font-weight: bold;\n          color: #4a5568;\n          font-size: 12px;\n          display: inline-block;\n          width: 100px;\n        }\n        .info-value {\n          color: #2d3748;\n        }\n        .items-table {\n          width: 100%;\n          border-collapse: collapse;\n          margin: 30px 0;\n        }\n        .items-table th {\n          background-color: #1a365d;\n          color: white;\n          padding: 12px;\n          text-align: left;\n          font-weight: bold;\n        }\n        .items-table td {\n          padding: 12px;\n          border-bottom: 1px solid #e2e8f0;\n        }\n        .items-table tr:nth-child(even) {\n          background-color: #f7fafc;\n        }\n        .text-right {\n          text-align: right;\n        }\n        .text-center {\n          text-align: center;\n        }\n        .totals-section {\n          margin-top: 30px;\n          display: flex;\n          justify-content: flex-end;\n        }\n        .totals-table {\n          width: 300px;\n        }\n        .totals-table td {\n          padding: 8px 12px;\n          border-bottom: 1px solid #e2e8f0;\n        }\n        .totals-table .total-row {\n          font-weight: bold;\n          font-size: 18px;\n          background-color: #1a365d;\n          color: white;\n        }\n        .status-badge {\n          display: inline-block;\n          padding: 4px 12px;\n          border-radius: 20px;\n          font-size: 12px;\n          font-weight: bold;\n          text-transform: uppercase;\n        }\n        .status-draft {\n          background-color: #e2e8f0;\n          color: #4a5568;\n        }\n        .status-sent {\n          background-color: #bee3f8;\n          color: #2a69ac;\n        }\n        .status-paid {\n          background-color: #c6f6d5;\n          color: #22543d;\n        }\n        .status-overdue {\n          background-color: #fed7d7;\n          color: #c53030;\n        }\n        .footer {\n          margin-top: 40px;\n          padding-top: 20px;\n          border-top: 1px solid #e2e8f0;\n          font-size: 11px;\n          color: #718096;\n        }\n        .payment-terms {\n          background-color: #f7fafc;\n          padding: 15px;\n          border-radius: 5px;\n          margin: 20px 0;\n          font-size: 12px;\n        }\n        .watermark {\n          position: fixed;\n          top: 50%;\n          left: 50%;\n          transform: translate(-50%, -50%) rotate(-45deg);\n          font-size: 72px;\n          color: rgba(0, 0, 0, 0.1);\n          z-index: -1;\n          font-weight: bold;\n        }\n      </style>\n    </head>\n    <body>\n      ${options.watermark ? `<div class=\"watermark\">${options.watermark}</div>` : ''}\n      \n      <!-- Header -->\n      <div class=\"header\">\n        <div>\n          <img src=\"${getCompanyLogo()}\" alt=\"G1 Holding\" class=\"logo\">\n        </div>\n        <div class=\"company-info\">\n          <div><strong>${COMPANY_INFO.name}</strong></div>\n          <div>${COMPANY_INFO.address.street}</div>\n          <div>${COMPANY_INFO.address.city}, ${COMPANY_INFO.address.country}</div>\n          <div>${COMPANY_INFO.address.postal}</div>\n          <div>Tel: ${COMPANY_INFO.contact.phone}</div>\n          <div>Email: ${COMPANY_INFO.contact.email}</div>\n          <div>VAT: ${COMPANY_INFO.registration.vat}</div>\n        </div>\n      </div>\n\n      <!-- Document Title -->\n      <div class=\"document-title\">INVOICE</div>\n      \n      <!-- Invoice Details -->\n      <div class=\"invoice-details\">\n        <div class=\"bill-to\">\n          <div class=\"section-title\">Bill To</div>\n          <div style=\"font-size: 16px; font-weight: bold; margin-bottom: 10px;\">${invoice.client?.name || 'N/A'}</div>\n          <div class=\"info-item\">\n            <span class=\"info-label\">Email:</span>\n            <span class=\"info-value\">${invoice.client?.email || 'N/A'}</span>\n          </div>\n          <div class=\"info-item\">\n            <span class=\"info-label\">Country:</span>\n            <span class=\"info-value\">${invoice.client?.country || 'N/A'}</span>\n          </div>\n          ${invoice.client?.address ? `\n          <div class=\"info-item\">\n            <span class=\"info-label\">Address:</span>\n            <span class=\"info-value\">${invoice.client.address}</span>\n          </div>\n          ` : ''}\n          ${invoice.client?.phone ? `\n          <div class=\"info-item\">\n            <span class=\"info-label\">Phone:</span>\n            <span class=\"info-value\">${invoice.client.phone}</span>\n          </div>\n          ` : ''}\n        </div>\n        \n        <div class=\"invoice-info\">\n          <div class=\"section-title\">Invoice Information</div>\n          <div class=\"info-item\">\n            <span class=\"info-label\">Invoice #:</span>\n            <span class=\"info-value\" style=\"font-weight: bold; font-size: 16px;\">${invoice.invoice_number}</span>\n          </div>\n          <div class=\"info-item\">\n            <span class=\"info-label\">Date:</span>\n            <span class=\"info-value\">${formatDate(invoice.created_at)}</span>\n          </div>\n          ${invoice.due_date ? `\n          <div class=\"info-item\">\n            <span class=\"info-label\">Due Date:</span>\n            <span class=\"info-value\">${formatDate(invoice.due_date)}</span>\n          </div>\n          ` : ''}\n          <div class=\"info-item\">\n            <span class=\"info-label\">Status:</span>\n            <span class=\"status-badge status-${invoice.status}\">${invoice.status.replace('_', ' ').toUpperCase()}</span>\n          </div>\n          <div class=\"info-item\">\n            <span class=\"info-label\">Currency:</span>\n            <span class=\"info-value\">${invoice.currency}</span>\n          </div>\n          ${invoice.skr ? `\n          <div class=\"info-item\">\n            <span class=\"info-label\">Related SKR:</span>\n            <span class=\"info-value\">${invoice.skr.skr_number}</span>\n          </div>\n          ` : ''}\n        </div>\n      </div>\n\n      <!-- Description -->\n      ${invoice.description ? `\n      <div style=\"margin-bottom: 20px; padding: 15px; background-color: #f7fafc; border-radius: 5px;\">\n        <div class=\"section-title\">Description</div>\n        <div>${invoice.description}</div>\n      </div>\n      ` : ''}\n\n      <!-- Items Table -->\n      <table class=\"items-table\">\n        <thead>\n          <tr>\n            <th style=\"width: 50%;\">Description</th>\n            <th class=\"text-center\" style=\"width: 15%;\">Quantity</th>\n            <th class=\"text-right\" style=\"width: 15%;\">Unit Price</th>\n            <th class=\"text-right\" style=\"width: 20%;\">Total</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${invoice.items?.map((item: any) => `\n            <tr>\n              <td>${item.description}</td>\n              <td class=\"text-center\">${item.quantity}</td>\n              <td class=\"text-right\">${formatCurrency(item.unit_price, invoice.currency)}</td>\n              <td class=\"text-right\">${formatCurrency(item.total, invoice.currency)}</td>\n            </tr>\n          `).join('') || '<tr><td colspan=\"4\" class=\"text-center\">No items</td></tr>'}\n        </tbody>\n      </table>\n\n      <!-- Totals -->\n      <div class=\"totals-section\">\n        <table class=\"totals-table\">\n          <tr>\n            <td>Subtotal:</td>\n            <td class=\"text-right\">${formatCurrency(subtotal, invoice.currency)}</td>\n          </tr>\n          ${invoice.tax_rate && invoice.tax_rate > 0 ? `\n          <tr>\n            <td>Tax (${(invoice.tax_rate * 100).toFixed(1)}%):</td>\n            <td class=\"text-right\">${formatCurrency(taxAmount, invoice.currency)}</td>\n          </tr>\n          ` : ''}\n          ${discountAmount > 0 ? `\n          <tr>\n            <td>Discount:</td>\n            <td class=\"text-right\">-${formatCurrency(discountAmount, invoice.currency)}</td>\n          </tr>\n          ` : ''}\n          <tr class=\"total-row\">\n            <td>TOTAL:</td>\n            <td class=\"text-right\">${formatCurrency(total, invoice.currency)}</td>\n          </tr>\n        </table>\n      </div>\n\n      <!-- Payment Terms -->\n      <div class=\"payment-terms\">\n        <div class=\"section-title\">Payment Terms & Information</div>\n        <div>• Payment is due ${invoice.due_date ? `by ${formatDate(invoice.due_date)}` : 'upon receipt'}</div>\n        <div>• Please reference invoice number ${invoice.invoice_number} when making payment</div>\n        <div>• For payment inquiries, contact: ${COMPANY_INFO.contact.email}</div>\n        <div>• Late payments may incur additional charges</div>\n      </div>\n\n      <!-- Notes -->\n      ${invoice.notes ? `\n      <div style=\"margin-top: 20px; padding: 15px; border: 1px solid #e2e8f0; border-radius: 5px;\">\n        <div class=\"section-title\">Notes</div>\n        <div>${invoice.notes}</div>\n      </div>\n      ` : ''}\n\n      <!-- Footer -->\n      <div class=\"footer\">\n        <div style=\"text-align: center; margin-bottom: 10px;\">\n          <strong>Thank you for your business!</strong>\n        </div>\n        <div>This invoice was generated electronically by G1 Holding's financial system.</div>\n        <div>Registration Number: ${COMPANY_INFO.registration.number} | VAT Number: ${COMPANY_INFO.registration.vat}</div>\n        <div>Generated on: ${formatDateTime(new Date().toISOString())}</div>\n      </div>\n    </body>\n    </html>\n  `\n\n  // Generate filename\n  const filename = `Invoice-${invoice.invoice_number}-${new Date().toISOString().split('T')[0]}.pdf`\n\n  // Generate PDF\n  return await generatePDFFromHTML(html, filename)\n}"