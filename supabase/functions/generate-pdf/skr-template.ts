import { SupabaseClient } from 'jsr:@supabase/supabase-js@2'\nimport { generatePDFFromHTML, formatCurrency, formatDate, formatDateTime, generateQRCode, getCompanyLogo, COMPANY_INFO, PDFOptions, PDFResult } from '../_shared/pdf-utils.ts'\n\nexport async function generateSKRPDF(\n  supabase: SupabaseClient,\n  skrId: string,\n  options: PDFOptions = {}\n): Promise<PDFResult> {\n  // Fetch SKR data with related information\n  const { data: skr, error } = await supabase\n    .from('skrs')\n    .select(`\n      *,\n      client:clients(*),\n      asset:assets(*),\n      tracking:tracking(*)\n    `)\n    .eq('id', skrId)\n    .single()\n\n  if (error || !skr) {\n    throw new Error(`SKR not found: ${error?.message || 'Unknown error'}`)\n  }\n\n  // Generate QR code for verification\n  const verificationUrl = `${Deno.env.get('SITE_URL')}/verify/skr/${skr.skr_number}`\n  const qrCodeDataUrl = options.includeQR ? generateQRCode(verificationUrl) : null\n\n  // Create HTML template\n  const html = `\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <meta charset=\"utf-8\">\n      <title>SKR - ${skr.skr_number}</title>\n      <style>\n        body {\n          font-family: 'Arial', sans-serif;\n          margin: 0;\n          padding: 20px;\n          color: #333;\n          line-height: 1.6;\n        }\n        .header {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          border-bottom: 3px solid #1a365d;\n          padding-bottom: 20px;\n          margin-bottom: 30px;\n        }\n        .logo {\n          width: 120px;\n          height: auto;\n        }\n        .company-info {\n          text-align: right;\n          font-size: 12px;\n          color: #666;\n        }\n        .document-title {\n          text-align: center;\n          font-size: 28px;\n          font-weight: bold;\n          color: #1a365d;\n          margin: 30px 0;\n          text-transform: uppercase;\n          letter-spacing: 2px;\n        }\n        .skr-number {\n          text-align: center;\n          font-size: 18px;\n          font-weight: bold;\n          color: #e53e3e;\n          margin-bottom: 30px;\n          padding: 10px;\n          border: 2px solid #e53e3e;\n          display: inline-block;\n          width: 100%;\n          box-sizing: border-box;\n        }\n        .section {\n          margin-bottom: 25px;\n          padding: 15px;\n          border: 1px solid #e2e8f0;\n          border-radius: 5px;\n        }\n        .section-title {\n          font-size: 16px;\n          font-weight: bold;\n          color: #1a365d;\n          margin-bottom: 15px;\n          border-bottom: 1px solid #cbd5e0;\n          padding-bottom: 5px;\n        }\n        .info-grid {\n          display: grid;\n          grid-template-columns: 1fr 1fr;\n          gap: 15px;\n        }\n        .info-item {\n          display: flex;\n          flex-direction: column;\n        }\n        .info-label {\n          font-weight: bold;\n          color: #4a5568;\n          font-size: 12px;\n          text-transform: uppercase;\n          margin-bottom: 3px;\n        }\n        .info-value {\n          font-size: 14px;\n          color: #2d3748;\n        }\n        .status-badge {\n          display: inline-block;\n          padding: 4px 12px;\n          border-radius: 20px;\n          font-size: 12px;\n          font-weight: bold;\n          text-transform: uppercase;\n        }\n        .status-issued {\n          background-color: #c6f6d5;\n          color: #22543d;\n        }\n        .status-draft {\n          background-color: #e2e8f0;\n          color: #4a5568;\n        }\n        .hash-section {\n          background-color: #f7fafc;\n          padding: 15px;\n          border-radius: 5px;\n          margin: 20px 0;\n        }\n        .hash-value {\n          font-family: 'Courier New', monospace;\n          font-size: 10px;\n          word-break: break-all;\n          background-color: #edf2f7;\n          padding: 10px;\n          border-radius: 3px;\n          margin-top: 5px;\n        }\n        .footer {\n          margin-top: 40px;\n          padding-top: 20px;\n          border-top: 1px solid #e2e8f0;\n          font-size: 11px;\n          color: #718096;\n          text-align: center;\n        }\n        .qr-section {\n          text-align: center;\n          margin: 20px 0;\n        }\n        .qr-code {\n          width: 100px;\n          height: 100px;\n        }\n        .watermark {\n          position: fixed;\n          top: 50%;\n          left: 50%;\n          transform: translate(-50%, -50%) rotate(-45deg);\n          font-size: 72px;\n          color: rgba(0, 0, 0, 0.1);\n          z-index: -1;\n          font-weight: bold;\n        }\n        .signature-section {\n          margin-top: 40px;\n          display: grid;\n          grid-template-columns: 1fr 1fr;\n          gap: 40px;\n        }\n        .signature-box {\n          border-top: 1px solid #000;\n          padding-top: 10px;\n          text-align: center;\n          font-size: 12px;\n        }\n      </style>\n    </head>\n    <body>\n      ${options.watermark ? `<div class=\"watermark\">${options.watermark}</div>` : ''}\n      \n      <!-- Header -->\n      <div class=\"header\">\n        <div>\n          <img src=\"${getCompanyLogo()}\" alt=\"G1 Holding\" class=\"logo\">\n        </div>\n        <div class=\"company-info\">\n          <div><strong>${COMPANY_INFO.name}</strong></div>\n          <div>${COMPANY_INFO.address.street}</div>\n          <div>${COMPANY_INFO.address.city}, ${COMPANY_INFO.address.country}</div>\n          <div>${COMPANY_INFO.address.postal}</div>\n          <div>Tel: ${COMPANY_INFO.contact.phone}</div>\n          <div>Email: ${COMPANY_INFO.contact.email}</div>\n        </div>\n      </div>\n\n      <!-- Document Title -->\n      <div class=\"document-title\">Secure Keeper Receipt</div>\n      \n      <!-- SKR Number -->\n      <div class=\"skr-number\">${skr.skr_number}</div>\n\n      <!-- SKR Information -->\n      <div class=\"section\">\n        <div class=\"section-title\">Receipt Information</div>\n        <div class=\"info-grid\">\n          <div class=\"info-item\">\n            <div class=\"info-label\">Status</div>\n            <div class=\"info-value\">\n              <span class=\"status-badge status-${skr.status}\">${skr.status.replace('_', ' ').toUpperCase()}</span>\n            </div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Issue Date</div>\n            <div class=\"info-value\">${skr.issue_date ? formatDateTime(skr.issue_date) : 'Not issued'}</div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Created Date</div>\n            <div class=\"info-value\">${formatDateTime(skr.created_at)}</div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Last Updated</div>\n            <div class=\"info-value\">${formatDateTime(skr.updated_at)}</div>\n          </div>\n        </div>\n      </div>\n\n      <!-- Client Information -->\n      <div class=\"section\">\n        <div class=\"section-title\">Client Information</div>\n        <div class=\"info-grid\">\n          <div class=\"info-item\">\n            <div class=\"info-label\">Client Name</div>\n            <div class=\"info-value\">${skr.client?.name || 'N/A'}</div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Client Type</div>\n            <div class=\"info-value\">${skr.client?.type?.replace('_', ' ').toUpperCase() || 'N/A'}</div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Email</div>\n            <div class=\"info-value\">${skr.client?.email || 'N/A'}</div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Country</div>\n            <div class=\"info-value\">${skr.client?.country || 'N/A'}</div>\n          </div>\n        </div>\n      </div>\n\n      <!-- Asset Information -->\n      <div class=\"section\">\n        <div class=\"section-title\">Asset Information</div>\n        <div class=\"info-grid\">\n          <div class=\"info-item\">\n            <div class=\"info-label\">Asset Name</div>\n            <div class=\"info-value\">${skr.asset?.asset_name || 'N/A'}</div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Asset Type</div>\n            <div class=\"info-value\">${skr.asset?.asset_type || 'N/A'}</div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Declared Value</div>\n            <div class=\"info-value\">${skr.asset ? formatCurrency(skr.asset.declared_value, skr.asset.currency) : 'N/A'}</div>\n          </div>\n          <div class=\"info-item\">\n            <div class=\"info-label\">Origin</div>\n            <div class=\"info-value\">${skr.asset?.origin || 'N/A'}</div>\n          </div>\n          ${skr.asset?.destination ? `\n          <div class=\"info-item\">\n            <div class=\"info-label\">Destination</div>\n            <div class=\"info-value\">${skr.asset.destination}</div>\n          </div>\n          ` : ''}\n        </div>\n        ${skr.asset?.specifications ? `\n        <div style=\"margin-top: 15px;\">\n          <div class=\"info-label\">Specifications</div>\n          <div class=\"info-value\" style=\"font-size: 12px; background-color: #f7fafc; padding: 10px; border-radius: 3px;\">\n            ${JSON.stringify(skr.asset.specifications, null, 2)}\n          </div>\n        </div>\n        ` : ''}\n      </div>\n\n      <!-- Digital Hash Section -->\n      ${skr.hash ? `\n      <div class=\"hash-section\">\n        <div class=\"section-title\">Digital Verification</div>\n        <div class=\"info-label\">Digital Hash (SHA-256)</div>\n        <div class=\"hash-value\">${skr.hash}</div>\n        <div style=\"margin-top: 10px; font-size: 11px; color: #666;\">\n          This digital hash ensures the authenticity and integrity of this document.\n          Any modification to the document will result in a different hash value.\n        </div>\n      </div>\n      ` : ''}\n\n      <!-- QR Code Section -->\n      ${qrCodeDataUrl ? `\n      <div class=\"qr-section\">\n        <div class=\"section-title\">Verification QR Code</div>\n        <img src=\"${qrCodeDataUrl}\" alt=\"Verification QR Code\" class=\"qr-code\">\n        <div style=\"font-size: 11px; color: #666; margin-top: 10px;\">\n          Scan this QR code to verify the authenticity of this document online\n        </div>\n      </div>\n      ` : ''}\n\n      <!-- Remarks -->\n      ${skr.remarks ? `\n      <div class=\"section\">\n        <div class=\"section-title\">Remarks</div>\n        <div class=\"info-value\">${skr.remarks}</div>\n      </div>\n      ` : ''}\n\n      <!-- Signature Section -->\n      ${options.includeSignature ? `\n      <div class=\"signature-section\">\n        <div class=\"signature-box\">\n          <div>Authorized Signature</div>\n          <div style=\"margin-top: 5px; font-size: 10px; color: #666;\">G1 Holding Representative</div>\n        </div>\n        <div class=\"signature-box\">\n          <div>Date</div>\n          <div style=\"margin-top: 5px; font-size: 10px; color: #666;\">${formatDate(new Date().toISOString())}</div>\n        </div>\n      </div>\n      ` : ''}\n\n      <!-- Footer -->\n      <div class=\"footer\">\n        <div>This document was generated electronically by G1 Holding's secure document system.</div>\n        <div>Registration Number: ${COMPANY_INFO.registration.number} | VAT Number: ${COMPANY_INFO.registration.vat}</div>\n        <div>Generated on: ${formatDateTime(new Date().toISOString())}</div>\n        ${qrCodeDataUrl ? `<div>Verify online at: ${verificationUrl}</div>` : ''}\n      </div>\n    </body>\n    </html>\n  `\n\n  // Generate filename\n  const filename = `SKR-${skr.skr_number}-${new Date().toISOString().split('T')[0]}.pdf`\n\n  // Generate PDF\n  return await generatePDFFromHTML(html, filename)\n}"